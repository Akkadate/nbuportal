<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBU Smart Portal Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f4f8;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-card:hover .fav-btn {
            opacity: 1;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 2px;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö Font ‡πÉ‡∏´‡πâ SweetAlert ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏° */
        div:where(.swal2-container) div:where(.swal2-popup) {
            font-family: 'Sarabun', sans-serif !important;
        }
    </style>
</head>

<body class="text-gray-700 h-screen flex flex-col overflow-hidden">

    <div id="loginModal"
        class="fixed inset-0 bg-[#002d62] bg-opacity-95 z-50 flex items-center justify-center p-4 fade-in hidden">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-400 to-orange-500"></div>
            <div
                class="w-24 h-24 bg-[#002d62] text-white rounded-full flex items-center justify-center text-4xl font-bold mx-auto mb-6 shadow-lg border-4 border-yellow-400">
                N</div>
            <h1 class="text-2xl font-bold text-[#002d62]">North Bangkok University</h1>
            <p class="text-gray-500 text-sm mb-8">Smart Portal Service Integration</p>
            <button onclick="handleAuthClick()"
                class="w-full bg-white border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 text-gray-700 font-semibold py-3 px-4 rounded-xl flex items-center justify-center transition-all duration-300 group shadow-sm">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg"
                    class="w-6 h-6 mr-3 transition group-hover:scale-110">
                <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google (@northbkk.ac.th)</span>
            </button>
            <p id="loginStatus" class="mt-4 text-xs h-4 text-red-500"></p>
        </div>
    </div>

    <div id="mainDashboard" class="hidden flex-1 flex flex-col h-full">
        <header
            class="bg-white shadow-sm border-b border-gray-200 z-30 h-16 flex items-center justify-between px-4 sm:px-8">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-[#002d62] rounded-lg flex items-center justify-center text-white font-bold">N
                </div>
                <div>
                    <h2 class="font-bold text-[#002d62]">NBU Portal</h2>
                    <p class="text-[10px] text-gray-500">SMART CAMPUS</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
                    <div class="text-right hidden sm:block">
                        <p id="userName" class="text-sm font-bold text-gray-800">...</p>
                        <p id="userDept" class="text-[11px] text-blue-600">Checking...</p>
                    </div>
                    <img id="userAvatar" src="" class="w-9 h-9 rounded-full border border-gray-200 p-0.5">
                    <button onclick="handleSignout()" class="ml-2 text-gray-400 hover:text-red-500 transition"
                        title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
            <div class="max-w-7xl mx-auto space-y-6">

                <div
                    class="bg-gradient-to-r from-[#002d62] to-blue-800 rounded-2xl p-6 text-white shadow-lg flex justify-between items-center relative overflow-hidden">
                    <div class="relative z-10">
                        <h1 class="text-2xl font-bold mb-1">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, <span id="welcomeName">...</span> üëã</h1>
                        <p class="text-blue-200 text-sm opacity-90">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
                    </div>
                    <i
                        class="fa-solid fa-shapes absolute right-0 bottom-0 text-9xl text-white opacity-5 -mr-4 -mb-4"></i>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div
                        class="bg-white rounded-2xl p-5 shadow-sm border-t-4 border-red-500 relative overflow-hidden group">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold text-gray-700"><i class="fa-regular fa-envelope mr-2 text-red-500"></i>
                                ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢ (Primary)</h3>
                        </div>
                        <div class="flex items-baseline gap-2">
                            <span id="unreadCount" class="text-4xl font-bold text-gray-800">-</span><span
                                class="text-sm text-gray-500">‡∏â‡∏ö‡∏±‡∏ö (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô)</span>
                        </div>
                        <a href="https://mail.google.com" target="_blank"
                            class="mt-4 inline-block text-xs bg-red-50 text-red-600 px-3 py-1 rounded-full hover:bg-red-100 transition">‡πÄ‡∏õ‡∏¥‡∏î
                            Gmail</a>
                    </div>
                    <div
                        class="bg-white rounded-2xl p-5 shadow-sm border-t-4 border-yellow-500 relative overflow-hidden">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold text-gray-700"><i
                                    class="fa-regular fa-calendar-check mr-2 text-yellow-600"></i> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        </div>
                        <div id="eventList"
                            class="space-y-2 max-h-32 overflow-y-auto pr-1 text-sm text-gray-500 custom-scrollbar"><i
                                class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                    <div
                        class="bg-gradient-to-br from-cyan-500 to-blue-500 rounded-2xl p-5 text-white shadow-md relative overflow-hidden">
                        <div class="flex justify-between items-start relative z-10">
                            <div>
                                <p id="weatherLocation" class="text-cyan-100 text-xs font-semibold uppercase mb-1">
                                    Checking Location...</p>
                                <h3 id="weatherTemp" class="text-3xl font-bold">--¬∞C</h3>
                                <p id="weatherDesc" class="text-sm opacity-90 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                            </div>
                            <i id="weatherIcon" class="fa-solid fa-cloud-sun text-5xl text-yellow-300"></i>
                        </div>
                        <div class="mt-4 pt-4 border-t border-white/20 text-xs flex justify-between relative z-10">
                            <span id="weatherWind">‡∏•‡∏°: -- km/h</span>
                        </div>
                    </div>
                </div>

                <section>
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-yellow-500 pl-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î (My
                        Favorite)</h2>
                    <div id="favoriteContainer"
                        class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 min-h-[100px]">
                        <p class="col-span-full text-gray-400 text-sm text-center py-8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p>
                    </div>
                </section>

                <section class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i
                            class="fa-solid fa-layer-group mr-2 text-blue-600"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                    <div id="allAppsContainer" class="space-y-8">
                        <div class="text-center text-gray-400 py-10"><i
                                class="fa-solid fa-circle-notch fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const CLIENT_ID = '943386992862-ed3f5r93lbpe9095d5lca13t811mm4fo.apps.googleusercontent.com';
        const BACKEND_URL = './'; // URL ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Backend
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';

        let tokenClient, accessToken = null;
        let allApps = [], myFavIds = [];

        window.onload = async function () {
            // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Login)
            loadWeather();

            // 2. ‡πÄ‡∏ä‡πá‡∏Ñ Session ‡∏Å‡∏±‡∏ö Server
            const isLoggedIn = await checkServerSession();

            // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Google Client
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: async (resp) => {
                    if (resp.access_token) {
                        localStorage.setItem('google_access_token', resp.access_token);

                        if (document.getElementById('loginModal').classList.contains('hidden')) {
                            loadGmailData(resp.access_token);
                            loadCalendarData(resp.access_token);
                        } else {
                            await processLoginWithGoogle(resp.access_token);
                        }
                    }
                },
            });

            if (!isLoggedIn) {
                document.getElementById('loginModal').classList.remove('hidden');
            } else {
                const storedToken = localStorage.getItem('google_access_token');
                if (storedToken) {
                    loadGmailData(storedToken);
                    loadCalendarData(storedToken);
                } else {
                    showConnectButtons();
                }
            }
        };

        // --- Auth Logic ---
        async function checkServerSession() {
            try {
                const res = await fetch(BACKEND_URL + 'auth.php');
                const data = await res.json();
                if (data.status === 'authenticated') {
                    showDashboard(data.user);
                    return true;
                }
                return false;
            } catch (err) { console.error("Auth Error", err); return false; }
        }

        function handleAuthClick() { tokenClient.requestAccessToken({ prompt: 'consent' }); }

        async function processLoginWithGoogle(accessToken) {
            const statusText = document.getElementById('loginStatus');
            statusText.innerText = 'Checking Database...';

            try {
                const profileRes = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const googleUser = await profileRes.json();

                const dbCheck = await fetch(BACKEND_URL + 'check_db.php', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: googleUser.email, avatar: googleUser.picture })
                });
                const dbResult = await dbCheck.json();

                if (dbResult.status === 'success') {
                    location.reload();
                } else {
                    statusText.innerText = 'Access Denied: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                    statusText.classList.add('text-red-500');
                }
            } catch (error) {
                console.error(error);
                statusText.innerText = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
            }
        }

        function showDashboard(user) {
            document.getElementById('userName').innerText = user.name;
            document.getElementById('welcomeName').innerText = user.name.split(' ')[0];
            document.getElementById('userAvatar').src = user.avatar;
            document.getElementById('userDept').innerText = `${user.role.toUpperCase()} | ${user.dept}`;

            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            document.getElementById('mainDashboard').classList.add('fade-in');

            loadDashboardApps();
        }

        // --- Modified Signout Logic with SweetAlert2 ---
        function handleSignout() {
            Swal.fire({
                title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
                text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33', // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô logout
                cancelButtonColor: '#3085d6', // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                reverseButtons: true
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // ‡πÅ‡∏™‡∏î‡∏á Loading ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠ Logout
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Logout
                    const token = localStorage.getItem('google_access_token');
                    if (token) {
                        try {
                            google.accounts.oauth2.revoke(token);
                        } catch (e) { console.log(e); }
                    }
                    localStorage.removeItem('google_access_token');

                    try {
                        await fetch(BACKEND_URL + 'logout.php');
                    } catch (e) { console.log(e); }

                    location.reload();
                }
            });
        }

        function showConnectButtons() {
            const btn = '<button onclick="handleAuthClick()" class="text-xs text-blue-500 underline">Connect</button>';
            document.getElementById('unreadCount').innerHTML = btn;
            document.getElementById('eventList').innerHTML = '<div class="text-center mt-4">' + btn + '</div>';
        }

        // --- Data Loading Functions ---
        async function loadGmailData(token) {
            try {
                const res = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/labels/INBOX', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Token Expired");
                const data = await res.json();
                document.getElementById('unreadCount').innerText = data.messagesUnread || 0;
            } catch (err) {
                console.warn("Gmail load failed:", err);
                showConnectButtons();
            }
        }

        async function loadCalendarData(token) {
            const container = document.getElementById('eventList');
            const now = new Date();
            const endOfDay = new Date(); endOfDay.setHours(23, 59, 59);
            try {
                const url = `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${now.toISOString()}&timeMax=${endOfDay.toISOString()}&singleEvents=true&orderBy=startTime`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error("Token Expired");
                const data = await res.json();

                container.innerHTML = '';
                if (data.items && data.items.length > 0) {
                    data.items.forEach(event => {
                        let timeStr = event.start.dateTime ? new Date(event.start.dateTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : "All Day";
                        const link = event.hangoutLink ? `<a href="${event.hangoutLink}" target="_blank" class="text-blue-500 hover:text-blue-700 ml-1"><i class="fa-solid fa-video"></i></a>` : '';
                        container.innerHTML += `<div class="flex items-center gap-3 py-2 border-b border-gray-50 last:border-0 hover:bg-gray-50 rounded px-1 transition"><span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded min-w-[45px] text-center">${timeStr}</span><span class="truncate flex-1 text-sm text-gray-700 font-medium">${event.summary} ${link}</span></div>`;
                    });
                } else { container.innerHTML = '<p class="text-center py-4 text-gray-400 text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>'; }
            } catch (err) {
                console.warn("Calendar load failed");
                showConnectButtons();
            }
        }

        // --- Weather API (Dynamic Location + Place Name) ---
        async function loadWeather() {
            if (navigator.geolocation) {
                document.getElementById('weatherLocation').innerText = "Locating...";
                navigator.geolocation.getCurrentPosition(
                    (p) => fetchWeatherData(p.coords.latitude, p.coords.longitude),
                    (e) => fetchWeatherData(13.9130, 100.6070, "Bangkok (Sapanmai)") // Fallback
                );
            } else { fetchWeatherData(13.9130, 100.6070, "Bangkok (Sapanmai)"); }
        }

        async function fetchWeatherData(lat, lon, fallbackName = "") {
            try {
                // 1. Get Weather
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&windspeed_unit=kmh`);
                const weatherData = await weatherRes.json();
                const w = weatherData.current_weather;

                // 2. Get Location Name (Reverse Geocoding)
                let locationName = fallbackName;
                if (!locationName) {
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`);
                        const geoData = await geoRes.json();
                        locationName = geoData.address.city || geoData.address.town || geoData.address.suburb || "Unknown Location";
                    } catch (e) { locationName = "Unknown Location"; }
                }

                document.getElementById('weatherLocation').innerText = locationName;
                document.getElementById('weatherTemp').innerText = `${Math.round(w.temperature)}¬∞C`;
                document.getElementById('weatherWind').innerText = `‡∏•‡∏°: ${w.windspeed} km/h`;

                const code = w.weathercode;
                let desc = "‡∏õ‡∏Å‡∏ï‡∏¥"; let icon = "fa-sun"; let color = "text-yellow-300";
                if (code === 0) { desc = "‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡πÅ‡∏à‡πà‡∏°‡πÉ‡∏™"; icon = "fa-sun"; color = "text-yellow-300"; }
                else if (code >= 1 && code <= 3) { desc = "‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô"; icon = "fa-cloud-sun"; color = "text-gray-100"; }
                else if (code >= 45 && code <= 48) { desc = "‡∏°‡∏µ‡∏´‡∏°‡∏≠‡∏Å"; icon = "fa-smog"; color = "text-gray-300"; }
                else if (code >= 51 && code <= 55) { desc = "‡∏ù‡∏ô‡∏õ‡∏£‡∏≠‡∏¢‡πÜ"; icon = "fa-cloud-rain"; color = "text-blue-200"; }
                else if (code >= 61 && code <= 67) { desc = "‡∏ù‡∏ô‡∏ï‡∏Å"; icon = "fa-cloud-showers-heavy"; color = "text-blue-300"; }
                else if (code >= 80 && code <= 82) { desc = "‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å"; icon = "fa-cloud-showers-water"; color = "text-blue-400"; }
                else if (code >= 95) { desc = "‡∏û‡∏≤‡∏¢‡∏∏‡∏ù‡∏ô‡∏ü‡πâ‡∏≤‡∏Ñ‡∏∞‡∏ô‡∏≠‡∏á"; icon = "fa-cloud-bolt"; color = "text-yellow-400"; }

                document.getElementById('weatherDesc').innerText = desc;
                document.getElementById('weatherIcon').className = `fa-solid ${icon} text-5xl ${color} animate-pulse`;
            } catch (err) { console.error("Weather Error", err); }
        }

        // --- Apps Logic ---
        async function loadDashboardApps() {
            try {
                const res = await fetch(BACKEND_URL + 'get_dashboard.php');
                const text = await res.text();

                try {
                    const data = JSON.parse(text);
                    if (data.status === 'success') {
                        allApps = data.apps;
                        myFavIds = data.favorites;
                        renderApps();
                    } else {
                        console.error("API Error:", data.message);
                        document.getElementById('allAppsContainer').innerHTML = `<div class="col-span-full text-center text-red-400 py-10">Error: ${data.message}</div>`;
                    }
                } catch (e) {
                    console.error("JSON Parse Error:", text);
                    document.getElementById('allAppsContainer').innerHTML = `<div class="col-span-full text-center text-red-400 py-10">Server Error</div>`;
                }
            } catch (err) {
                console.error("Fetch Apps Error:", err);
                document.getElementById('allAppsContainer').innerHTML = `<div class="col-span-full text-center text-red-400 py-10">Connection Failed</div>`;
            }
        }

        function renderApps() {
            const favContainer = document.getElementById('favoriteContainer');
            const allContainer = document.getElementById('allAppsContainer');

            favContainer.innerHTML = '';
            allContainer.innerHTML = '';

            const favApps = allApps.filter(app => myFavIds.includes(app.app_id));
            if (favApps.length > 0) {
                favApps.forEach(app => favContainer.innerHTML += createAppCard(app, true));
            } else {
                favContainer.innerHTML = '<p class="col-span-full text-gray-400 text-sm text-center py-8">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏π‡∏õ‡∏î‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î</p>';
            }

            const grouped = allApps.reduce((acc, app) => {
                const cat = app.category_name || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(app);
                return acc;
            }, {});

            for (const [category, apps] of Object.entries(grouped)) {
                let categoryHTML = `
                    <div class="mb-8">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 border-b pb-2 border-gray-100 flex items-center">
                            <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded mr-2"><i class="fa-solid fa-folder"></i></span> ${category}
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${apps.map(app => createAppCard(app, false)).join('')}
                        </div>
                    </div>
                `;
                allContainer.innerHTML += categoryHTML;
            }
        }

        function createAppCard(app, isFavSection) {
            const isFav = myFavIds.includes(app.app_id);
            const starClass = isFav ? "text-yellow-400" : "text-gray-300";
            const colors = ['blue', 'orange', 'green', 'purple', 'teal'];
            const color = colors[app.app_id % colors.length];

            return `
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition relative group app-card flex items-center gap-3">
                    <div class="w-10 h-10 bg-${color}-50 text-${color}-600 rounded-lg flex items-center justify-center text-lg shrink-0 transition group-hover:bg-${color}-600 group-hover:text-white">
                        <i class="fa-solid ${app.icon_class}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-gray-700 text-sm truncate">${app.app_name}</h4>
                        <p class="text-xs text-gray-400 truncate">${app.app_description}</p>
                    </div>
                    <a href="${app.app_url}" target="_blank" class="absolute inset-0 z-0"></a>
                    <button onclick="toggleFavorite(${app.app_id})" class="fav-btn absolute top-2 right-2 z-10 ${isFavSection ? '' : 'opacity-0'} transition hover:scale-110 bg-white rounded-full p-1 shadow-sm border border-gray-100">
                        <i class="fa-solid fa-star ${starClass} text-xs"></i>
                    </button>
                </div>
            `;
        }

        async function toggleFavorite(appId) {
            const isFav = myFavIds.includes(appId);
            const action = isFav ? 'remove' : 'add';
            if (isFav) { myFavIds = myFavIds.filter(id => id !== appId); }
            else { myFavIds.push(appId); }
            renderApps();
            await fetch(BACKEND_URL + 'toggle_favorite.php', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ app_id: appId, action: action })
            });
        }
    </script>
</body>

</html>